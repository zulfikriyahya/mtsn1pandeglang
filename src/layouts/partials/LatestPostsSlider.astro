---
import ImageMod from "@/components/ImageMod.astro";
import { getSinglePage } from "@/lib/contentParser.astro";
import { sortByDate } from "@/lib/utils/sortFunctions";
import dateFormat from "@/lib/utils/dateFormat";
import readingTime from "@/lib/utils/readingTime";
import CardViewCounter from "@/layouts/helpers/CardViewCounter";
import { humanize } from "@/lib/utils/textConverter";
import {
  FaRegClock,
  FaRegCalendarAlt,
  FaArrowRight,
  FaRegEye,
} from "react-icons/fa";

// 1. Ambil data blog
const posts = await getSinglePage("blog");
// 2. Urutkan dari yang terbaru
const sortedPosts = sortByDate(posts);
// 3. Ambil 6 postingan terbaru saja
const latestPosts = sortedPosts.slice(0, 6);
---

<section class="section bg-light dark:bg-darkmode-light overflow-hidden">
  <div class="container">
    <!-- Header Section -->
    <div class="mb-12 text-center">
      <h2 class="h2 gsap-fade-up">Berita & Artikel Terbaru</h2>
      <p
        class="mt-4 text-text-light dark:text-darkmode-text-light gsap-fade-up"
      >
        Ikuti perkembangan informasi terkini dan kegiatan seru di MTs Negeri 1
        Pandeglang.
      </p>
    </div>

    <!-- Swiper Container -->
    <div class="gsap-fade-up relative">
      <div class="swiper latest-posts-slider !pb-12">
        <div class="swiper-wrapper">
          {
            latestPosts.map((post) => (
              <div class="swiper-slide h-auto">
                <div class="group h-full flex flex-col overflow-hidden rounded-2xl border border-border bg-body transition-all duration-300 hover:-translate-y-1 hover:shadow-lg dark:border-darkmode-border dark:bg-darkmode-body">
                  {/* Image Thumbnail */}
                  <div class="relative h-56 overflow-hidden">
                    {post.data.image ? (
                      <ImageMod
                        src={post.data.image}
                        height={300}
                        width={600}
                        alt={post.data.title}
                        class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-110"
                        format="webp"
                      />
                    ) : (
                      <div class="flex h-full w-full items-center justify-center bg-gray-200 text-gray-400">
                        No Image
                      </div>
                    )}

                    {/* Badge Kategori */}
                    <div class="absolute left-4 top-4">
                      <span class="rounded-md bg-white/90 px-3 py-1 text-xs font-bold uppercase tracking-wider text-primary shadow-sm backdrop-blur-sm dark:bg-black/80 dark:text-white">
                        {humanize(post.data.categories[0])}
                      </span>
                    </div>
                  </div>

                  {/* Content */}
                  <div class="flex flex-1 flex-col p-6">
                    {/* Meta Data */}
                    <div class="mb-3 flex items-center gap-4 text-xs text-text-light dark:text-darkmode-text-light">
                      <div class="flex items-center gap-1">
                        <FaRegCalendarAlt />
                        {dateFormat(post.data.date)}
                      </div>
                      <div class="flex items-center gap-1">
                        <FaRegClock />
                        {readingTime(post.body)}
                      </div>
                      <div class="flex items-center gap-1">
                        <CardViewCounter client:visible slug={post.id} />
                      </div>
                    </div>

                    {/* Title */}
                    <h3 class="h5 mb-3 flex-1 font-bold leading-snug">
                      <a
                        href={`/blog/${post.id}`}
                        class="transition-colors hover:text-primary hover:underline decoration-2 underline-offset-4"
                      >
                        {post.data.title}
                      </a>
                    </h3>

                    {/* Link Read More */}
                    <div class="mt-4 pt-4 border-t border-border dark:border-darkmode-border">
                      <a
                        href={`/blog/${post.id}`}
                        class="group/link flex items-center text-sm font-semibold text-primary transition-colors hover:text-dark dark:hover:text-white"
                      >
                        Baca Selengkapnya
                        <FaArrowRight className="ml-2 transition-transform duration-300 group-hover/link:translate-x-1" />
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            ))
          }
        </div>

        {/* Pagination Dots Container */}
        <div class="latest-posts-pagination mt-8 flex justify-center gap-2">
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  import { Swiper } from "swiper";
  import "swiper/css";
  import "swiper/css/pagination";
  import { Autoplay, Pagination } from "swiper/modules";

  const initLatestPostsSlider = () => {
    new Swiper(".latest-posts-slider", {
      modules: [Pagination, Autoplay],
      spaceBetween: 24,
      loop: true,
      autoplay: {
        delay: 4000,
        disableOnInteraction: false,
        pauseOnMouseEnter: true,
      },
      pagination: {
        el: ".latest-posts-pagination",
        type: "bullets",
        clickable: true,
      },
      breakpoints: {
        0: { slidesPerView: 1 },
        768: { slidesPerView: 2 },
        1024: { slidesPerView: 3 },
      },
    });
  };

  document.addEventListener("astro:page-load", initLatestPostsSlider);
</script>
