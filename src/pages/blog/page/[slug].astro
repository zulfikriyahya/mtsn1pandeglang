---
import BlogCard from "@/components/BlogCard.astro";
import Pagination from "@/components/Pagination.astro";
import config from "@/config/config.json";
import Base from "@/layouts/Base.astro";
import PageHeader from "@/partials/PageHeader.astro";
import PostSidebar from "@/partials/PostSidebar.astro";
import {
  getArticles,
  getCategories,
  getTags,
  getAssetURL,
} from "@/lib/directus";

// 1. Generate Static Paths untuk Pagination
export async function getStaticPaths() {
  const articles = await getArticles({
    filter: { status: { _eq: "published" } },
  });
  const totalPages = Math.ceil(articles.length / config.settings.pagination);
  const paths = [];

  for (let i = 1; i < totalPages; i++) {
    paths.push({
      params: {
        slug: (i + 1).toString(), // Mulai dari halaman 2
      },
      props: { articles }, // Pass articles agar tidak fetch ulang
    });
  }
  return paths;
}

const { slug } = Astro.params;
const { articles: allArticles } = Astro.props;

// Fetch data sidebar (Category & Tags)
const categories = await getCategories();
const tags = await getTags();
const categoryNames = categories.map((c) => c.name);
const tagNames = tags.map((t) => t.name);

// Get Used Categories for Count
const usedCategories = allArticles
  .flatMap(
    (article) =>
      article.categories?.map((cat: any) => cat.categories_id?.name || "") ||
      [],
  )
  .filter(Boolean);

// Logic Pagination
const currentPage = slug && !isNaN(Number(slug)) ? Number(slug) : 1;
const paginationLength = config.settings.pagination;
const totalPages = Math.ceil(allArticles.length / paginationLength);
const indexOfLastPost = currentPage * paginationLength;
const indexOfFirstPost = indexOfLastPost - paginationLength;
const currentArticles = allArticles.slice(indexOfFirstPost, indexOfLastPost);

// Mapping Data untuk BlogCard
const mappedArticles = currentArticles.map((article) => ({
  id: article.slug,
  body: article.excerpt || article.content,
  data: {
    title: article.title,
    image: getAssetURL(article.featured_image),
    date: article.publish_date,
    author: typeof article.author === "object" ? article.author?.name : "Admin",
    categories: article.categories?.map((c: any) => c.categories_id?.name) || [
      "Uncategorized",
    ],
  },
}));

const pageTitle = "Artikel Terkini";
---

<Base
  title={pageTitle}
  meta_title={`Blog Page ${currentPage} - ${config.site.title}`}
>
  <PageHeader title={pageTitle} />
  <section class="section">
    <div class="container">
      <div class="row gx-5">
        <!-- Blog Posts -->
        <div class="lg:col-8">
          <div class="row gsap-stagger-container">
            {
              mappedArticles.map((post) => (
                <div class="mb-14 md:col-6">
                  <BlogCard data={post} />
                </div>
              ))
            }
          </div>
          <Pagination
            section="blog"
            currentPage={currentPage}
            totalPages={totalPages}
          />
        </div>

        <!-- Sidebar -->
        <PostSidebar
          categories={categoryNames}
          tags={tagNames}
          allCategories={usedCategories}
        />
      </div>
    </div>
  </section>
</Base>
