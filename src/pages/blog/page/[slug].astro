---
import BlogCard from "@/components/BlogCard.astro";
import Pagination from "@/components/Pagination.astro";
import config from "@/config/config.json";
import Base from "@/layouts/Base.astro";
import PageHeader from "@/partials/PageHeader.astro";
import PostSidebar from "@/partials/PostSidebar.astro";
import {
  getArticles,
  getCategories,
  getTags,
  getAssetURL,
} from "@/lib/directus";

export async function getStaticPaths() {
  const articles = await getArticles();
  const totalPages = Math.ceil(articles.length / config.settings.pagination);
  const paths = [];

  for (let i = 1; i < totalPages; i++) {
    paths.push({
      params: { slug: (i + 1).toString() },
      props: { allArticles: articles },
    });
  }
  return paths;
}

const { slug } = Astro.params;
const { allArticles } = Astro.props;
const currentPage = Number(slug);

// Pagination Logic
const paginationLength = config.settings.pagination;
const totalPages = Math.ceil(allArticles.length / paginationLength);
const indexOfLastPost = currentPage * paginationLength;
const indexOfFirstPost = indexOfLastPost - paginationLength;
const currentArticles = allArticles.slice(indexOfFirstPost, indexOfLastPost);

// Mapping Articles
const mappedArticles = currentArticles.map((article) => ({
  id: article.slug,
  body: article.excerpt || article.content,
  data: {
    title: article.title,
    image: getAssetURL(article.featured_image),
    date: article.publish_date,
    author: typeof article.author === "object" ? article.author?.name : "Admin",
    categories:
      article.categories?.map((c: any) => c.categories_id?.name) || [],
  },
}));

// Sidebar Data
const categories = await getCategories();
const tags = await getTags();
const usedCategories = allArticles.flatMap(
  (a) => a.categories?.map((c: any) => c.categories_id?.name) || [],
);
---

<Base title={`Blog Halaman ${currentPage}`}>
  <PageHeader title="Artikel Terkini" />
  <section class="section">
    <div class="container">
      <div class="row gx-5">
        <div class="lg:col-8">
          <div class="row gsap-stagger-container">
            {
              mappedArticles.map((post) => (
                <div class="mb-14 md:col-6">
                  <BlogCard data={post} />
                </div>
              ))
            }
          </div>
          <Pagination
            section="blog"
            currentPage={currentPage}
            totalPages={totalPages}
          />
        </div>
        <PostSidebar
          categories={categories.map((c) => c.name)}
          tags={tags.map((t) => t.name)}
          allCategories={usedCategories}
        />
      </div>
    </div>
  </section>
</Base>
