---
import BlogCard from "@/components/BlogCard.astro";
import Pagination from "@/components/Pagination.astro";
import config from "@/config/config.json";
import Base from "@/layouts/Base.astro";
import PageHeader from "@/partials/PageHeader.astro";
import PostSidebar from "@/partials/PostSidebar.astro";

// Import Directus functions
import {
  getArticles,
  getCategories,
  getTags,
  getAssetURL,
} from "@/lib/directus";

// Fetch data
const articles = await getArticles({
  sort: ["-publish_date"], // Sort by newest
  filter: { status: { _eq: "published" } },
});

const categories = await getCategories();
const tags = await getTags();

// Mapping categories for sidebar (array of strings)
const categoryNames = categories.map((c) => c.name);
const tagNames = tags.map((t) => t.name);

// Get all categories used in articles (for count in sidebar)
const usedCategories = articles
  .flatMap(
    (article) =>
      article.categories?.map((cat: any) => cat.categories_id?.name || "") ||
      [],
  )
  .filter(Boolean);

// Pagination Logic
const paginationLength = config.settings.pagination;
const totalPages = Math.ceil(articles.length / paginationLength);
const currentArticles = articles.slice(0, paginationLength);

// Map Directus Data to BlogCard props format
const mappedArticles = currentArticles.map((article) => ({
  id: article.slug, // BlogCard expects id/slug
  body: article.excerpt || article.content, // BlogCard uses body for summary
  data: {
    title: article.title,
    image: getAssetURL(article.featured_image),
    date: article.publish_date,
    author: typeof article.author === "object" ? article.author?.name : "Admin",
    categories: article.categories?.map((c: any) => c.categories_id?.name) || [
      "Uncategorized",
    ],
  },
}));

const pageTitle = "Artikel Terkini";
---

<Base title={pageTitle} meta_title={`Blog - ${config.site.title}`}>
  <PageHeader title={pageTitle} />

  <section class="section">
    <div class="container">
      <div class="row gx-5">
        <!-- Blog Posts Grid -->
        <div class="lg:col-8">
          <div class="row gsap-stagger-container">
            {
              mappedArticles.map((article) => (
                <div class="mb-14 md:col-6">
                  <BlogCard data={article} />
                </div>
              ))
            }
          </div>
          <Pagination section="blog" currentPage={1} totalPages={totalPages} />
        </div>

        <!-- Sidebar -->
        <PostSidebar
          categories={categoryNames}
          tags={tagNames}
          allCategories={usedCategories}
        />
      </div>
    </div>
  </section>
</Base>
