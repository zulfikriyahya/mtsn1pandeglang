---
import BlogCard from "@/components/BlogCard.astro";
import Pagination from "@/components/Pagination.astro";
import config from "@/config/config.json";
import Base from "@/layouts/Base.astro";
import PageHeader from "@/partials/PageHeader.astro";
import PostSidebar from "@/partials/PostSidebar.astro";
import {
  getArticles,
  getCategories,
  getTags,
  getAssetURL,
} from "@/lib/directus";

// 1. Fetch Data
const allArticles = await getArticles(); // Ambil semua untuk sidebar count
const categories = await getCategories();
const tags = await getTags();

// 2. Pagination Logic (Halaman 1)
const paginationLength = config.settings.pagination;
const totalPages = Math.ceil(allArticles.length / paginationLength);
const currentArticles = allArticles.slice(0, paginationLength);

// 3. Mapping Data untuk Komponen
const mappedArticles = currentArticles.map((article) => ({
  id: article.slug,
  body: article.excerpt || article.content,
  data: {
    title: article.title,
    image: getAssetURL(article.featured_image),
    date: article.publish_date,
    author: typeof article.author === "object" ? article.author?.name : "Admin",
    categories:
      article.categories?.map((c: any) => c.categories_id?.name) || [],
  },
}));

// Data Sidebar
const categoryNames = categories.map((c) => c.name);
const tagNames = tags.map((t) => t.name);
// Ambil semua kategori yang terpakai di artikel untuk hitung jumlah
const usedCategories = allArticles.flatMap(
  (article) => article.categories?.map((c: any) => c.categories_id?.name) || [],
);

const pageTitle = "Artikel Terkini";
---

<Base title={pageTitle}>
  <PageHeader title={pageTitle} />
  <section class="section">
    <div class="container">
      <div class="row gx-5">
        <!-- Blog Posts -->
        <div class="lg:col-8">
          <div class="row gsap-stagger-container">
            {
              mappedArticles.map((post) => (
                <div class="mb-14 md:col-6">
                  <BlogCard data={post} />
                </div>
              ))
            }
          </div>
          <Pagination section="blog" currentPage={1} totalPages={totalPages} />
        </div>

        <!-- Sidebar -->
        <PostSidebar
          categories={categoryNames}
          tags={tagNames}
          allCategories={usedCategories}
        />
      </div>
    </div>
  </section>
</Base>
