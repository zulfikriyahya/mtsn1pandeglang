---
import ImageMod from "@/components/ImageMod.astro";
import Base from "@/layouts/Base.astro";
import { markdownify } from "@/lib/utils/textConverter";
import CallToAction from "@/partials/CallToAction.astro";
import Testimonial from "@/partials/Testimonial.astro";
import { FaCheck } from "react-icons/fa";
import {
  getHomepageBanner,
  getHomepageFeatures,
  getTestimonials,
  getAssetURL,
} from "@/lib/directus";

// Fetch Data
const banner = await getHomepageBanner();
const features = await getHomepageFeatures();
const testimonials = await getTestimonials();

// Fallback Banner
const defaultBanner = {
  title: "Selamat Datang di MTs Negeri 1 Pandeglang",
  content: "Temukan pengalaman belajar terbaik di MTs Negeri 1 Pandeglang.",
  image: "/images/assets/banner.png",
  button_enable: true,
  button_label: "Daftar Sekarang!",
  button_link: "https://daftar.mtsn1pandeglang.sch.id",
};
const activeBanner = banner || defaultBanner;
const bannerImageUrl = banner?.image
  ? getAssetURL(banner.image)
  : defaultBanner.image;
---

<Base>
  <!-- Banner Section -->
  <section class="section pt-14">
    <div class="container">
      <div class="row justify-center items-center">
        <div class="lg:col-7 md:col-9 mb-8 text-center gsap-fade-up">
          <h1
            set:html={markdownify(activeBanner.title)}
            class="mb-4 text-h3 lg:text-h1"
          />
          <p set:html={markdownify(activeBanner.content)} class="mb-8" />
          {
            activeBanner.button_enable && (
              <a
                class="btn btn-primary transition-transform hover:scale-105"
                href={activeBanner.button_link}
              >
                {activeBanner.button_label}
              </a>
            )
          }
        </div>
        {
          bannerImageUrl && (
            <div class="col-12 gsap-fade-up">
              <ImageMod
                src={bannerImageUrl}
                alt={activeBanner.title}
                class="w-full h-auto rounded-xl shadow-lg"
                width={1200}
                height={380}
                format="webp"
              />
            </div>
          )
        }
      </div>
    </div>
  </section>

  <!-- Features Section -->
  {
    features.map((feature, index) => {
      const featureImageUrl = getAssetURL(feature.image);
      const isEven = index % 2 === 0;
      return (
        <section class={`section-sm ${isEven && "bg-gradient"}`}>
          <div class="container">
            <div class="row items-center justify-between">
              <div
                class={`mb:md-0 mb-6 md:col-5 gsap-fade-up ${!isEven && "md:order-2"}`}
              >
                {featureImageUrl && (
                  <ImageMod
                    src={featureImageUrl}
                    alt={feature.title}
                    class="w-full h-auto rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300"
                    width={520}
                    height={480}
                    format="webp"
                  />
                )}
              </div>
              <div
                class={`md:col-7 lg:col-6 gsap-fade-up ${!isEven && "md:order-1"}`}
              >
                <h2 set:html={markdownify(feature.title)} class="mb-4" />
                <p
                  set:html={markdownify(feature.content)}
                  class="mb-8 text-lg"
                />
                {feature.bulletpoints && (
                  <ul class="gsap-stagger-container">
                    {feature.bulletpoints.map((bullet: any) => (
                      <li class="relative mb-4 pl-6">
                        <FaCheck
                          className={"absolute left-0 top-1.5 text-primary"}
                        />
                        <span set:html={markdownify(bullet.text || bullet)} />
                      </li>
                    ))}
                  </ul>
                )}
                {feature.button_enable && (
                  <a class="btn btn-primary mt-5" href={feature.button_link}>
                    {feature.button_label}
                  </a>
                )}
              </div>
            </div>
          </div>
        </section>
      );
    })
  }

  <!-- Testimonials -->
  {
    testimonials.length > 0 && (
      <Testimonial
        testimonial={{
          data: {
            enable: true,
            title: "Apa Kata Mereka",
            description: "Testimoni dari alumni dan warga sekolah",
            testimonials: testimonials.map((t) => ({
              name: t.name,
              designation: t.designation,
              avatar: getAssetURL(t.avatar),
              content: t.content,
            })),
          },
        }}
      />
    )
  }

  <CallToAction
    call_to_action={{
      data: {
        enable: true,
        title: "Siap Bergabung?",
        description: "Daftarkan diri anda sekarang juga.",
        image: "/images/call-to-action.png",
        button: {
          enable: true,
          label: "Daftar",
          link: "https://daftar.mtsn1pandeglang.sch.id",
        },
      },
    }}
  />
</Base>
