---
import BlogCard from "@/components/BlogCard.astro";
import Base from "@/layouts/Base.astro";
import PageHeader from "@/partials/PageHeader.astro";
import { getTags, getArticles, getAssetURL } from "@/lib/directus";
import { humanize } from "@/lib/utils/textConverter";

export async function getStaticPaths() {
  const tags = await getTags();
  return tags.map((tag) => {
    return {
      params: { tag: tag.slug },
      props: { tagName: tag.name },
    };
  });
}

const { tag } = Astro.params;
const { tagName } = Astro.props;

const allArticles = await getArticles();
const filteredArticles = allArticles.filter((article) =>
  article.tags?.some((t: any) => t.tags_id?.slug === tag),
);

const mappedArticles = filteredArticles.map((article) => ({
  id: article.slug,
  body: article.excerpt || article.content,
  data: {
    title: article.title,
    image: getAssetURL(article.featured_image),
    date: article.publish_date,
    author: typeof article.author === "object" ? article.author?.name : "Admin",
    categories:
      article.categories?.map((c: any) => c.categories_id?.name) || [],
  },
}));
---

<Base title={`Tag: ${tagName}`}>
  <PageHeader title={`Tag: ${humanize(tagName)}`} />
  <div class="section-sm pb-0">
    <div class="container">
      <div class="row gsap-stagger-container">
        {
          mappedArticles.length > 0 ? (
            mappedArticles.map((post) => (
              <div class="mb-14 md:col-6 lg:col-4">
                <BlogCard data={post} />
              </div>
            ))
          ) : (
            <div class="col-12 text-center py-20">
              <p class="text-xl text-gray-500">
                Belum ada artikel dengan tag ini.
              </p>
            </div>
          )
        }
      </div>
    </div>
  </div>
</Base>
