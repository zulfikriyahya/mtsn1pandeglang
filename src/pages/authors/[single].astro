---
import BlogCard from "@/components/BlogCard.astro";
import ImageMod from "@/components/ImageMod.astro";
import Social from "@/components/Social.astro";
import Base from "@/layouts/Base.astro";
import { getAuthors, getArticles, getAssetURL } from "@/lib/directus";
import { markdownify, slugify } from "@/lib/utils/textConverter";

// 1. Generate Static Paths
export async function getStaticPaths() {
  const authors = await getAuthors();
  return authors.map((author) => ({
    params: { single: author.slug },
    props: { author },
  }));
}

const { author } = Astro.props;
const { name, bio, social_media, avatar, meta_title, meta_description } =
  author;
const imageUrl = getAssetURL(avatar);

// 2. Get Articles by Author
// Note: Kita fetch semua lalu filter. Jika artikel ribuan, sebaiknya filter di API level.
const allArticles = await getArticles();
const authorPosts = allArticles.filter((post) => {
  // Cek apakah post.author adalah object (populated) atau ID string
  const postAuthorSlug =
    typeof post.author === "object" && post.author !== null
      ? post.author.slug
      : "";
  return postAuthorSlug === author.slug;
});

// Mapping artikel untuk BlogCard
const mappedPosts = authorPosts.map((article) => ({
  id: article.slug,
  body: article.excerpt || article.content,
  data: {
    title: article.title,
    image: getAssetURL(article.featured_image),
    date: article.publish_date,
    author: name,
    categories:
      article.categories?.map((c: any) => c.categories_id?.name) || [],
  },
}));
---

<Base
  title={name}
  meta_title={meta_title || name}
  description={meta_description || bio?.slice(0, 150)}
  image={imageUrl}
>
  <section class="section-sm pb-0">
    <div class="container">
      <div
        class="row justify-center border-b border-border pb-14 dark:border-darkmode-border"
      >
        <div class="text-center lg:col-4 gsap-fade-up">
          {
            imageUrl && (
              <ImageMod
                src={imageUrl}
                class="mx-auto mb-10 rounded-full shadow-lg"
                height={200}
                width={200}
                alt={name}
                format="webp"
              />
            )
          }
          <h1 class="h3 mb-6">{name}</h1>
          <div class="content mb-6">
            <div set:html={markdownify(bio || "")} />
          </div>
          {
            social_media && (
              <Social source={social_media} className="social-icons" />
            )
          }
        </div>
      </div>

      <div class="row justify-center pb-16 pt-14 gsap-stagger-container">
        {
          mappedPosts.length > 0 ? (
            mappedPosts.map((post) => (
              <div class="mb-12 md:col-6 lg:col-4">
                <BlogCard data={post} />
              </div>
            ))
          ) : (
            <div class="text-center text-gray-500">
              <p>Belum ada artikel yang ditulis.</p>
            </div>
          )
        }
      </div>
    </div>
  </section>
</Base>
